// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// Modelo de Usuario (extendido del base de NextAuth.js o similar)
model User {
  id               String    @id @default(cuid())
  email            String    @unique
  password         String?   // Para autenticación con credenciales
  image            String?
  
  // Sistema de roles basado en capacidades
  isSuperAdmin     Boolean   @default(false)
  isEnrollmentAdmin Boolean   @default(false)
  isProfesor     Boolean   @default(false)
  isStudent        Boolean   @default(true)

  // Campos adicionales del modelo de Usuario
  nombres          String
  apellido_paterno String
  apellido_materno String?
  telefono         String?
  
  foto_perfil      String?
  biografia        String?
  numero_matricula String?   @unique

  // Relaciones
  coursesEnrolled Enrollment[] // Cursos a los que el alumno está inscrito
  coursesCreated  Course[]     @relation("ProfesorCourses") // Cursos creados por este profesor
  courseDrafts    CourseDraft[] @relation("DraftProfesor") // Borradores de cursos creados por este profesor
  enrollmentRequests EnrollmentRequest[]

  // Para el progreso del curso (JSON)
  progreso_cursos Json? // { "curso_slug": { "modulo_1": ["clase_1_1"], ... } }

  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
}



// Modelo de Curso
model Course {
  id                 String     @id @default(cuid())
  titulo             String
  slug               String     @unique
  descripcion_corta  String
  descripcion_larga  String
  imagen_portada     String?
  video_presentacion String?
  modalidad          Modalidad
  nivel              Nivel
  publico_objetivo   PublicoObjetivo
  precio             Float
  activo             Boolean    @default(true)

  // Relaciones
  profesorId         String?
  profesor           User?      @relation("ProfesorCourses", fields: [profesorId], references: [id])
  enrollments        Enrollment[] // Alumnos inscritos en este curso
  enrollmentRequests EnrollmentRequest[]

  modulos            Module[]
  recursos_generales Resource[] @relation("CourseResources")
  draft              CourseDraft? // Borrador de cambios para este curso

  createdAt          DateTime   @default(now())
  updatedAt          DateTime   @updatedAt
}

enum Modalidad {
  OnlineGrabado
  OnlineEnVivo
  Presencial
  Hibrido
  CapacitacionEmpresas
}

enum Nivel {
  Basico
  Intermedio
  Avanzado
}

enum PublicoObjetivo {
  Profesionales
  Ninos
  General
}

// Modelo de Módulo (relacionado con Curso)
model Module {
  id        String   @id @default(cuid())
  titulo    String
  order     Int      @default(0)

  courseId  String
  course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)

  clases    Class[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Modelo de Clase (relacionado con Módulo)
model Class {
  id               String         @id @default(cuid())
  titulo           String
  tipo_contenido   TipoContenido
  contenido_video   String? // URL del video (ej. YouTube, Vimeo)
  videoFilePath     String? // Ruta al archivo de video subido localmente
  videoMimeType     String? // Tipo MIME del archivo de video
  videoFileSize     Int?    // Tamaño del archivo de video en bytes
  contenido_texto  String?
  order            Int            @default(0)

  moduleId         String
  module           Module         @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  // Relaciones
  quizId           String?
  quiz             Quiz?          @relation(fields: [quizId], references: [id])
  exerciseId       String?
  exercise         Exercise?      @relation(fields: [exerciseId], references: [id]) // Relación con el nuevo modelo Exercise
  recursos_clase   Resource[]     @relation("ClassResources")

  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
}

enum TipoContenido {
  Video
  Texto
  Quiz
  Ejercicio
}

// Modelo Ejercicio (ahora es un modelo regular)
model Exercise {
  id            String   @id @default(cuid())
  instrucciones String
  // Podríamos añadir más campos aquí si los ejercicios son complejos
  class         Class[] // Relación inversa con Class

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

// Modelo de Quiz (Colección independiente)
model Quiz {
  id        String     @id @default(cuid())
  titulo    String
  classes   Class[] // Clases que usan este quiz
  preguntas Question[]

  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
}

// Modelo de Pregunta (relacionado con Quiz)
model Question {
  id        String   @id @default(cuid())
  texto     String
  order     Int      @default(0)

  quizId    String
  quiz      Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)

  opciones  Option[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Modelo de Opción (relacionado con Pregunta)
model Option {
  id          String   @id @default(cuid())
  texto       String
  es_correcta Boolean  @default(false)

  questionId  String
  question    Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// Modelo de Recurso (para recursos generales del curso o de la clase)
model Resource {
  id        String   @id @default(cuid())
  nombre    String
  url       String?
  filePath  String?
  mimeType  String?
  fileSize  Int?
  tipo      String   @default("Enlace") // Puede ser "Enlace", "PDF", "Video", etc.
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relación con Class
  classId String?
  class   Class?   @relation("ClassResources", fields: [classId], references: [id], onDelete: Cascade)

  // Relación con Course (para recursos generales del curso)
  courseId String?
  course   Course? @relation("CourseResources", fields: [courseId], references: [id], onDelete: Cascade)
}

// Modelo de Inscripción (para la relación entre User y Course)
model Enrollment {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  courseId  String
  course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  
  fecha_inscripcion DateTime @default(now())
  completado        Boolean  @default(false)

  @@unique([userId, courseId]) // Un usuario solo puede inscribirse una vez en un curso
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum EnrollmentStatus {
  PENDING
  APPROVED
  REJECTED
}

model EnrollmentRequest {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  courseId  String
  course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  status    EnrollmentStatus @default(PENDING)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, courseId])
}

// Modelo de Borrador de Curso (para cambios pendientes de revisión)
model CourseDraft {
  id                 String     @id @default(cuid())
  courseId           String     @unique // Enlace al curso original
  course             Course     @relation(fields: [courseId], references: [id], onDelete: Cascade)
  
  profesorId       String?     // Quién creó el borrador
  profesor         User?      @relation("DraftProfesor", fields: [profesorId], references: [id])

  titulo             String
  slug               String
  descripcion_corta  String
  descripcion_larga  String
  imagen_portada     String?
  video_presentacion String?
  modalidad          Modalidad
  nivel              Nivel
  publico_objetivo   PublicoObjetivo
  precio             Float
  
  isPendingReview    Boolean    @default(true) // Indica si el borrador está pendiente de revisión

  createdAt          DateTime   @default(now())
  updatedAt          DateTime   @updatedAt
}